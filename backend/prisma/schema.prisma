// 資訊資產管理系統 - 資料庫結構
// Database: SQLite

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ========== 系統管理 ==========

// 使用者
model User {
  id            Int    @id @default(autoincrement())
  account       String    @unique
  password      String   
  name          String   
  email         String   
  departmentId  Int?   @map("department_id")
  status        String    @default("active") // active, inactive
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  department    Department?      @relation(fields: [departmentId], references: [id])
  roles         UserRole[]
  createdAssets Asset[]          @relation("AssetCreatedBy")
  updatedAssets Asset[]          @relation("AssetUpdatedBy")
  custodianOf   Asset[]          @relation("AssetCustodian")
  inventoryRecords InventoryRecord[]
  loginLogs     LoginLog[]
  auditLogs     AuditLog[]

  @@map("users")
}

// 角色
model Role {
  id          Int   @id @default(autoincrement())
  code        String   @unique
  name        String  
  description String? 
  isSystem    Boolean  @default(false) @map("is_system")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  users       UserRole[]
  permissions RolePermission[]

  @@map("roles")
}

// 使用者-角色關聯
model UserRole {
  id        Int   @id @default(autoincrement())
  userId    Int   @map("user_id")
  roleId    Int   @map("role_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([userId, roleId])
  @@map("user_roles")
}

// 權限
model Permission {
  id          Int   @id @default(autoincrement())
  module      String  
  action      String  
  name        String  
  description String? 
  createdAt   DateTime @default(now()) @map("created_at")

  roles RolePermission[]

  @@unique([module, action])
  @@map("permissions")
}

// 角色-權限關聯
model RolePermission {
  id           Int   @id @default(autoincrement())
  roleId       Int   @map("role_id")
  permissionId Int   @map("permission_id")
  createdAt    DateTime @default(now()) @map("created_at")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@map("role_permissions")
}

// 登入紀錄
model LoginLog {
  id        Int   @id @default(autoincrement())
  userId    Int   @map("user_id")
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  status    String   // success, failed
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("login_logs")
}

// ========== 基礎資料 ==========

// 部門
model Department {
  id        Int   @id @default(autoincrement())
  code      String   @unique
  name      String  
  parentId  Int?  @map("parent_id")
  managerId Int?  @map("manager_id")
  status    String   @default("active")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  parent   Department?  @relation("DepartmentHierarchy", fields: [parentId], references: [id])
  children Department[] @relation("DepartmentHierarchy")
  users    User[]
  assets   Asset[]

  @@map("departments")
}

// 存放位置
model Location {
  id        Int   @id @default(autoincrement())
  code      String   @unique
  name      String  
  parentId  Int?  @map("parent_id")
  level     Int      @default(1) // 1:廠區/大樓, 2:樓層, 3:區域
  status    String   @default("active")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  parent   Location?  @relation("LocationHierarchy", fields: [parentId], references: [id])
  children Location[] @relation("LocationHierarchy")
  assets   Asset[]

  @@map("locations")
}

// 資產分類
model Category {
  id            Int   @id @default(autoincrement())
  code          String   @unique
  name          String  
  parentId      Int?  @map("parent_id")
  level         Int      @default(1) // 1:大類, 2:小類
  depreciationYears Int? @map("depreciation_years")
  description   String? 
  status        String   @default("active")
  sortOrder     Int      @default(0) @map("sort_order")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  assets   Asset[]

  @@map("categories")
}

// 供應商
model Supplier {
  id           Int   @id @default(autoincrement())
  code         String   @unique
  name         String  
  taxId        String?  @map("tax_id") // 統一編號
  contactName  String?  @map("contact_name")
  phone        String? 
  email        String? 
  address      String? 
  serviceItems String?  @map("service_items")
  status       String   @default("active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  assets Asset[]

  @@map("suppliers")
}

// 資產狀態代碼
model AssetStatus {
  id          Int   @id @default(autoincrement())
  code        String   @unique
  name        String  
  description String? 
  color       String?  // 顯示顏色
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("asset_statuses")
}

// ========== 資產管理 ==========

// 資產主檔
model Asset {
  id            Int    @id @default(autoincrement())
  assetNo       String    @unique @map("asset_no")
  categoryId    Int    @map("category_id")
  name          String   
  specModel     String?   @map("spec_model")
  serialNo      String?   @map("serial_no")
  acquireDate   DateTime  @map("acquire_date")
  acquireAmount Float?  @map("acquire_amount")
  supplierId    Int?   @map("supplier_id")
  purchaseNo    String?   @map("purchase_no")
  departmentId  Int    @map("department_id")
  custodianId   Int    @map("custodian_id")
  locationId    Int?   @map("location_id")
  status        String    @default("in_use")
  warrantyDate  DateTime? @map("warranty_date")
  remark        String?  
  erpSyncTime   DateTime? @map("erp_sync_time")
  createdBy     Int    @map("created_by")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedBy     Int    @map("updated_by")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  category    Category     @relation(fields: [categoryId], references: [id])
  supplier    Supplier?    @relation(fields: [supplierId], references: [id])
  department  Department   @relation(fields: [departmentId], references: [id])
  custodian   User         @relation("AssetCustodian", fields: [custodianId], references: [id])
  location    Location?    @relation(fields: [locationId], references: [id])
  createdByUser User       @relation("AssetCreatedBy", fields: [createdBy], references: [id])
  updatedByUser User       @relation("AssetUpdatedBy", fields: [updatedBy], references: [id])
  movements   AssetMovement[]
  attachments AssetAttachment[]
  inventoryRecords InventoryRecord[]

  @@index([departmentId])
  @@index([status])
  @@index([categoryId])
  @@map("assets")
}

// 資產異動紀錄
model AssetMovement {
  id            Int   @id @default(autoincrement())
  assetId       Int   @map("asset_id")
  movementType  String   @map("movement_type") // transfer, borrow, return, repair, scrap
  fromDeptId    Int?  @map("from_dept_id")
  toDeptId      Int?  @map("to_dept_id")
  fromLocationId Int? @map("from_location_id")
  toLocationId  Int?  @map("to_location_id")
  fromCustodianId Int? @map("from_custodian_id")
  toCustodianId Int?  @map("to_custodian_id")
  reason        String? 
  remark        String? 
  status        String   @default("pending") // pending, approved, rejected, completed
  createdBy     Int   @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")
  approvedBy    Int?  @map("approved_by")
  approvedAt    DateTime? @map("approved_at")

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@map("asset_movements")
}

// 資產附件
model AssetAttachment {
  id          Int   @id @default(autoincrement())
  assetId     Int   @map("asset_id")
  fileName    String   @map("file_name")
  filePath    String   @map("file_path")
  fileSize    Int      @map("file_size")
  mimeType    String   @map("mime_type")
  description String? 
  createdBy   Int   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")

  asset Asset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@map("asset_attachments")
}

// ========== 盤點管理 ==========

// 盤點計畫
model InventoryPlan {
  id          Int   @id @default(autoincrement())
  name        String  
  description String? 
  startDate   DateTime @map("start_date")
  endDate     DateTime @map("end_date")
  status      String   @default("draft") // draft, in_progress, completed, closed
  scopeType   String   @map("scope_type") // all, department, location, category
  scopeIds    String?  @map("scope_ids") // JSON array of IDs
  createdBy   Int   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  records InventoryRecord[]

  @@map("inventory_plans")
}

// 盤點紀錄
model InventoryRecord {
  id             Int   @id @default(autoincrement())
  planId         Int   @map("plan_id")
  assetNo        String   @map("asset_no")
  ocrRawText     String?  @map("ocr_raw_text")
  ocrCategory    String?  @map("ocr_category")
  ocrName        String?  @map("ocr_name")
  ocrDate        String?  @map("ocr_date")
  imagePath      String?  @map("image_path")
  matchStatus    String   @map("match_status") // matched, unmatched, discrepancy
  matchAssetId   Int?  @map("match_asset_id")
  discrepancyNote String? @map("discrepancy_note")
  scannedBy      Int   @map("scanned_by")
  scannedAt      DateTime @map("scanned_at")
  gpsLatitude    Float? @map("gps_latitude")
  gpsLongitude   Float? @map("gps_longitude")
  createdAt      DateTime @default(now()) @map("created_at")

  plan     InventoryPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  asset    Asset?        @relation(fields: [matchAssetId], references: [id])
  scannedByUser User     @relation(fields: [scannedBy], references: [id])

  @@index([planId])
  @@index([assetNo])
  @@map("inventory_records")
}

// ========== 系統 ==========

// 稽核日誌
model AuditLog {
  id         Int   @id @default(autoincrement())
  userId     Int?  @map("user_id")
  action     String  
  tableName  String   @map("table_name")
  recordId   Int?  @map("record_id")
  oldValue   String?  @map("old_value")
  newValue   String?  @map("new_value")
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id])

  @@index([tableName, recordId])
  @@map("audit_logs")
}

// ERP 同步紀錄
model ErpSyncLog {
  id          Int   @id @default(autoincrement())
  syncType    String   @map("sync_type") // full, incremental
  status      String   // running, success, failed
  totalCount  Int      @default(0) @map("total_count")
  addedCount  Int      @default(0) @map("added_count")
  updatedCount Int     @default(0) @map("updated_count")
  errorCount  Int      @default(0) @map("error_count")
  errorLog    String?  @map("error_log")
  startedAt   DateTime @map("started_at")
  finishedAt  DateTime? @map("finished_at")
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("erp_sync_logs")
}
